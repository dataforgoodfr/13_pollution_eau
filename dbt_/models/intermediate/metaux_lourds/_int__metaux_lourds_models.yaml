version: 2

models:
  - name: int__resultats_metaux_lourds_udi_dernier
    description: >
      Résultats des métaux lourds (Pb et As) par UDI
      pour la temporalité 'dernier prélèvement'
    columns:
      - name: categorie
        tests:
          - not_null
          - accepted_values:
              values:
                - metaux_lourds_pb
                - metaux_lourds_as

      - name: cdreseau
        description: "Code de l'installation (unité de distribution)"
        type: VARCHAR
        tests:
          - not_null

      - name: dernier_prel_datetime
        description: >
          Date et heure du dernier prélèvement
          pris en compte dans l'analyse
        type: TIMESTAMP
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= CURRENT_DATE - INTERVAL 1 YEAR"

      - name: periode
        description: "Période de résultat"
        type: VARCHAR
        tests:
          - accepted_values:
              values: ["dernier_prel"]

      - name: dernier_prel_valeur
        description: "Valeur du dernier prélèvement"
        type: FLOAT

      - name: resultat
        description: "Résultat"
        type: VARCHAR
        tests:
          - not_null
          - accepted_values:
              values:
                - non_quantifie
                - sup_limite_qualite
                - sup_limite_qualite_2036
                - sup_limite_sanitaire
                - inf_5
                - as_sup_10_inf_13
                - inf_10

  - name: int__resultats_metaux_lourds_commune_dernier
    description: >
      Résultats des métaux lourds (Pb et As) par UDI
      pour la temporalité 'dernier prélèvement'
    columns:
      - name: categorie
        tests:
          - not_null
          - accepted_values:
              values:
                - metaux_lourds_pb
                - metaux_lourds_as

      - name: inseecommune
        description: "Code INSEE de la commune"
        type: VARCHAR
        tests:
          - not_null

      - name: dernier_prel_datetime
        description: >
          Date et heure du dernier prélèvement
          pris en compte dans l'analyse
        type: TIMESTAMP
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= CURRENT_DATE - INTERVAL 1 YEAR"

      - name: periode
        description: "Période de résultat"
        type: VARCHAR
        tests:
          - accepted_values:
              values: ["dernier_prel"]

      - name: dernier_prel_valeur
        description: "Valeur du dernier prélèvement"
        type: FLOAT

      - name: resultat
        description: "Résultat"
        type: VARCHAR
        tests:
          - not_null
          - accepted_values:
              values:
                - non_quantifie
                - sup_limite_qualite
                - sup_limite_qualite_2036
                - sup_limite_sanitaire
                - inf_5
                - as_sup_10_inf_13
                - inf_10

  - name: int__resultats_metaux_lourds_commune_annuel
    description: >
      Résultats des métaux lourds (Pb et As) par
      commune pour la temporalité 'bilan_annuel'
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - inseecommune
            - annee
            - categorie
    columns:
      - name: inseecommune
        description: "Code INSEE de la commune"
        type: VARCHAR
        tests:
          - not_null

      - name: annee
        description: "Année de prélèvement"
        type: smallint
        tests:
          - not_null

      - name: categorie
        description: Catégorie du paramètre
        tests:
          - not_null
          - accepted_values:
              values:
                - metaux_lourds_pb
                - metaux_lourds_as

      - name: periode
        description: "Période du résultat"
        type: VARCHAR
        tests:
          - dbt_utils.expression_is_true:
              expression: "LIKE 'bilan_annuel%'"

      - name: nb_depassements
        type: INTEGER

      - name: nb_prelevements
        type: INTEGER

      - name: ratio_limite_sanitaire
        description: >
          Pourcentage de prélèvements qui dépassent la
          limite sanitaire
        type: FLOAT
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1

  - name: int__resultats_metaux_lourds_udi_annuel
    description: >
      Résultats des métaux lourds (Pb et As) par
      UDI pour la temporalité 'bilan_annuel'
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - cdreseau
            - annee
            - categorie
    columns:
      - name: cdreseau
        description: Code de l'installation (unité de distribution)
        type: VARCHAR
        tests:
          - not_null

      - name: annee
        description: "Année de prélèvement"
        type: smallint
        tests:
          - not_null

      - name: categorie
        description: Catégorie du paramètre
        tests:
          - not_null
          - accepted_values:
              values:
                - metaux_lourds_pb
                - metaux_lourds_as

      - name: periode
        description: "Période du résultat"
        type: VARCHAR
        tests:
          - dbt_utils.expression_is_true:
              expression: "LIKE 'bilan_annuel%'"

      - name: nb_depassements
        type: INTEGER

      - name: nb_prelevements
        type: INTEGER

      - name: ratio_limite_sanitaire
        description: >
          Pourcentage de prélèvements qui dépassent la
          limite sanitaire
        type: FLOAT
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
